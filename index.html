<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visita T√©cnica de Obra</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{ --rojo:#c62828; --rojo-oscuro:#a31515; --rojo-sutil:rgba(198,40,40,0.07); --gris:#757575; --fondo:#f5f5f5; }
* { box-sizing:border-box; }
body { font-family:'Open Sans',Arial,sans-serif; background:var(--fondo); margin:0; padding:20px; min-height:100vh; }

/* === FONDO GEOM√âTRICO SIEMPRE VISIBLE === */
.geo-bg { position:fixed; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
.geo-bg canvas { position:absolute; inset:0; width:100%; height:100%; }

/* === CONTENEDOR === */
.contenedor { position:relative; z-index:1; max-width:520px; margin:auto; background:#fff; padding:28px 24px; border-radius:14px; box-shadow:0 6px 30px rgba(198,40,40,0.10),0 2px 8px rgba(0,0,0,0.08); text-align:center; }
h1 { font-family:'Montserrat',sans-serif; font-weight:900; margin-bottom:6px; color:#000; font-size:1.35rem; letter-spacing:-0.5px; }
h2 { font-family:'Montserrat',sans-serif; font-weight:700; color:#000; margin-bottom:12px; }

/* === BANNER LOGIN === */
.banner-animacion { width:100%; height:180px; background:linear-gradient(180deg,#1a2a4a 0%,#2d4a7a 50%,#4a7a9b 100%); border-radius:10px; margin-bottom:18px; position:relative; overflow:hidden; }
.cielo-nubes { position:absolute; top:0; left:0; width:200%; height:60%; animation:moverNubes 20s linear infinite; }
.suelo { position:absolute; bottom:0; width:100%; height:38px; background:repeating-linear-gradient(45deg,#FFD700,#FFD700 10px,#222 10px,#222 20px); opacity:0.7; }
.ingeniero { position:absolute; bottom:38px; width:75px; height:75px; animation:caminar 5s linear infinite; filter:drop-shadow(2px 3px 4px rgba(0,0,0,0.4)); }
.ingeniero svg { width:100%; height:100%; }
.camion { position:absolute; bottom:38px; width:120px; height:70px; animation:caminar2 9s linear infinite; animation-delay:-4s; filter:drop-shadow(2px 3px 4px rgba(0,0,0,0.3)); }
.grua-fija { position:absolute; right:30px; bottom:38px; width:160px; height:140px; }
.edificio-fijo { position:absolute; left:30px; bottom:38px; width:100px; height:120px; }

@keyframes caminar  { 0%{left:-100px;}  100%{left:calc(100% + 20px);} }
@keyframes caminar2 { 0%{right:-130px;} 100%{right:calc(100% + 20px);} }
@keyframes moverNubes { 0%{transform:translateX(0);} 100%{transform:translateX(-50%);} }
@keyframes gruar { 0%,100%{transform:scaleX(1);} 50%{transform:scaleX(-1);} }

/* === VERSION BADGE === */
.version-badge { position:absolute; top:10px; right:12px; background:var(--rojo); color:#fff; font-family:'Montserrat',sans-serif; font-weight:700; font-size:11px; padding:3px 9px; border-radius:20px; letter-spacing:0.5px; box-shadow:0 2px 6px rgba(198,40,40,0.4); z-index:5; }

/* === INPUTS === */
input,textarea,select { width:100%; padding:10px 12px; margin-top:6px; margin-bottom:14px; border-radius:8px; border:1.5px solid #ddd; font-family:'Open Sans',sans-serif; font-size:14px; transition:border-color 0.2s; outline:none; }
input:focus,textarea:focus,select:focus { border-color:var(--rojo); box-shadow:0 0 0 3px rgba(198,40,40,0.08); }
label { text-align:left; display:block; font-weight:600; font-size:13px; margin-bottom:2px; }

/* === BOTONES === */
button { width:100%; padding:11px; margin-top:6px; margin-bottom:12px; border-radius:8px; border:none; font-family:'Montserrat',sans-serif; font-weight:700; font-size:14px; cursor:pointer; background:linear-gradient(135deg,var(--rojo) 0%,var(--rojo-oscuro) 100%); color:#fff; letter-spacing:0.3px; box-shadow:0 3px 10px rgba(198,40,40,0.25); transition:transform 0.15s,box-shadow 0.15s; }
button:hover { transform:translateY(-1px); box-shadow:0 5px 16px rgba(198,40,40,0.35); }
button:active { transform:translateY(0); }
.btn-secundario { background:linear-gradient(135deg,#757575 0%,#555 100%); box-shadow:0 3px 10px rgba(0,0,0,0.15); }
.btn-azul { background:linear-gradient(135deg,#1565c0,#0d47a1); box-shadow:0 3px 10px rgba(21,101,192,0.25); }
.btn-small { width:auto; padding:7px 16px; font-size:12px; margin:4px; display:inline-block; }

/* === INFO PROYECTO === */
.info-proyecto { background:var(--rojo-sutil); border-left:3px solid var(--rojo); padding:10px 14px; border-radius:0 8px 8px 0; margin-bottom:16px; font-size:13px; color:#333; text-align:left; }

/* === TARJETAS MODO === */
.modo-card { border:2px solid #eee; border-radius:12px; padding:20px 18px; margin:10px 0; cursor:pointer; transition:border-color 0.2s,box-shadow 0.2s,transform 0.15s; text-align:left; background:#fafafa; }
.modo-card:hover { border-color:var(--rojo); box-shadow:0 4px 18px rgba(198,40,40,0.12); transform:translateY(-2px); }
.modo-card .modo-icon { font-size:1.8rem; margin-bottom:8px; display:block; }
.modo-card h3 { font-family:'Montserrat',sans-serif; font-weight:700; font-size:0.95rem; margin:0 0 5px; color:#111; }
.modo-card p { font-size:12px; color:#666; margin:0; line-height:1.4; }
.modo-card.nuevo { border-color:var(--rojo); background:var(--rojo-sutil); }

/* === FOTOS === */
.fotos-container { margin:10px 0; }
.foto-item { position:relative; margin:8px 0; border-radius:8px; overflow:hidden; border:1px solid #ddd; }
.foto-item img { width:100%; display:block; }
.btn-eliminar-foto { position:absolute; top:6px; right:6px; width:auto; padding:4px 10px; font-size:11px; margin:0; border-radius:20px; background:rgba(198,40,40,0.85); box-shadow:none; }
.label-fotos-cantidad { font-size:12px; color:var(--gris); text-align:right; margin:-10px 0 8px; display:block; }

/* === CARRUSEL OBSERVACIONES === */
.obs-card { background:#fafafa; border-radius:12px; border:1px solid #eee; border-left:4px solid var(--rojo); padding:18px 16px 14px; text-align:left; min-height:160px; }
.obs-card h3 { font-family:'Montserrat',sans-serif; font-weight:700; color:var(--rojo); margin:0 0 10px; font-size:1rem; }
.obs-card p { margin:4px 0; font-size:13px; color:#333; word-break:break-word; }
.nav-obs { display:flex; align-items:center; justify-content:space-between; margin:12px 0 6px; gap:10px; }
.nav-obs button { width:44px; height:44px; border-radius:50%; padding:0; font-size:18px; margin:0; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
.nav-obs button:disabled { background:#ccc; box-shadow:none; cursor:not-allowed; transform:none; }
.nav-obs .obs-indicator { font-family:'Montserrat',sans-serif; font-weight:700; font-size:13px; color:var(--gris); flex:1; text-align:center; }
.carrusel-fotos { position:relative; margin:12px 0; }
.carrusel-fotos img { width:100%; border-radius:8px; display:block; border:1px solid #ddd; }
.nav-fotos { display:flex; align-items:center; justify-content:space-between; margin:6px 0 4px; gap:8px; }
.nav-fotos button { width:36px; height:36px; border-radius:50%; padding:0; font-size:15px; margin:0; flex-shrink:0; }
.nav-fotos button:disabled { background:#ccc; box-shadow:none; cursor:not-allowed; transform:none; }
.nav-fotos .foto-indicator { font-size:12px; color:var(--gris); text-align:center; flex:1; font-family:'Montserrat',sans-serif; font-weight:600; }
.fotos-barra { display:flex; justify-content:center; gap:6px; margin:6px 0; }
.fotos-barra span { width:8px; height:8px; border-radius:50%; background:#ddd; display:inline-block; transition:background 0.2s; }
.fotos-barra span.activo { background:var(--rojo); }

/* === EDICI√ìN === */
.obs-edit-area { display:none; margin-top:14px; padding-top:14px; border-top:1px solid #eee; }
.obs-edit-area.activo { display:block; }

/* === COLORES IMPACTO === */
.impacto-critico { color:#c62828; font-weight:700; }
.impacto-alto    { color:#e65100; font-weight:700; }
.impacto-medio   { color:#f57f17; font-weight:700; }
.impacto-bajo    { color:#2e7d32; font-weight:700; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- FONDO GEOM√âTRICO CANVAS (siempre activo) -->
<div class="geo-bg"><canvas id="geoCanvas"></canvas></div>

<!-- ===== PANTALLA 1: LOGIN ===== -->
<div id="pantallaLogin" class="contenedor">
  <span class="version-badge">v1.1</span>
  <div class="banner-animacion">
    <!-- Nubes SVG animadas -->
    <svg class="cielo-nubes" viewBox="0 0 800 80" preserveAspectRatio="none" style="position:absolute;top:0;left:0;width:200%;height:55%;">
      <ellipse cx="80"  cy="30" rx="60" ry="18" fill="rgba(255,255,255,0.18)"/>
      <ellipse cx="200" cy="20" rx="45" ry="14" fill="rgba(255,255,255,0.13)"/>
      <ellipse cx="340" cy="35" rx="70" ry="20" fill="rgba(255,255,255,0.16)"/>
      <ellipse cx="500" cy="18" rx="55" ry="16" fill="rgba(255,255,255,0.12)"/>
      <ellipse cx="650" cy="28" rx="65" ry="18" fill="rgba(255,255,255,0.15)"/>
      <ellipse cx="480" cy="42" rx="40" ry="12" fill="rgba(255,255,255,0.10)"/>
      <ellipse cx="150" cy="50" rx="50" ry="15" fill="rgba(255,255,255,0.11)"/>
    </svg>

    <!-- EDIFICIO EN CONSTRUCCI√ìN (fijo) -->
    <svg class="edificio-fijo" viewBox="0 0 100 130">
      <rect x="5"  y="40" width="90" height="90" fill="#546e7a" stroke="#37474f" stroke-width="2"/>
      <rect x="12" y="50" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="34" y="50" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="56" y="50" width="16" height="16" fill="rgba(0,0,0,0.5)"/>
      <rect x="78" y="50" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="12" y="72" width="16" height="16" fill="rgba(0,0,0,0.5)"/>
      <rect x="34" y="72" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="56" y="72" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="78" y="72" width="16" height="16" fill="rgba(0,0,0,0.5)"/>
      <rect x="12" y="94" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="34" y="94" width="16" height="16" fill="rgba(0,0,0,0.5)"/>
      <rect x="56" y="94" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <rect x="78" y="94" width="16" height="16" fill="#FFD700" opacity="0.9"/>
      <!-- Andamios -->
      <line x1="0" y1="40" x2="0"   y2="130" stroke="#FFD700" stroke-width="3"/>
      <line x1="100" y1="40" x2="100" y2="130" stroke="#FFD700" stroke-width="3"/>
      <line x1="0" y1="55" x2="100" y2="55" stroke="#FFD700" stroke-width="1.5" stroke-dasharray="4,4"/>
      <line x1="0" y1="75" x2="100" y2="75" stroke="#FFD700" stroke-width="1.5" stroke-dasharray="4,4"/>
      <line x1="0" y1="95" x2="100" y2="95" stroke="#FFD700" stroke-width="1.5" stroke-dasharray="4,4"/>
    </svg>

    <!-- GR√öA TORRE (fija derecha) -->
    <svg class="grua-fija" viewBox="0 0 160 150">
      <!-- Torre -->
      <rect x="72" y="20" width="10" height="130" fill="#c62828"/>
      <line x1="72" y1="30" x2="82" y2="40" stroke="#a31515" stroke-width="1.5"/>
      <line x1="72" y1="40" x2="82" y2="50" stroke="#a31515" stroke-width="1.5"/>
      <line x1="72" y1="50" x2="82" y2="60" stroke="#a31515" stroke-width="1.5"/>
      <line x1="72" y1="60" x2="82" y2="70" stroke="#a31515" stroke-width="1.5"/>
      <line x1="72" y1="70" x2="82" y2="80" stroke="#a31515" stroke-width="1.5"/>
      <line x1="72" y1="80" x2="82" y2="90" stroke="#a31515" stroke-width="1.5"/>
      <!-- Brazo horizontal -->
      <rect x="10" y="16" width="140" height="7" fill="#FFD700"/>
      <!-- Cabina -->
      <rect x="68" y="8" width="18" height="12" fill="#37474f" rx="2"/>
      <!-- Cable con gancho -->
      <line x1="115" y1="23" x2="115" y2="75" stroke="#222" stroke-width="1.5"/>
      <path d="M110,75 Q115,82 120,75" fill="none" stroke="#222" stroke-width="2"/>
      <!-- Contrapeso -->
      <rect x="12" y="12" width="22" height="14" fill="#37474f" rx="2"/>
    </svg>

    <!-- MEZCLADORA DE CONCRETO (animada, viene de la derecha) -->
    <div class="camion" style="position:absolute;bottom:38px;right:-130px;animation:caminar2 9s linear infinite;animation-delay:-2s;">
      <svg viewBox="0 0 140 80" width="140" height="80">
        <!-- Cabina -->
        <rect x="5"  y="28" width="35" height="30" fill="#c62828" rx="3"/>
        <rect x="10" y="33" width="13" height="10" fill="#87CEEB" opacity="0.8"/>
        <rect x="25" y="33" width="10" height="10" fill="#87CEEB" opacity="0.8"/>
        <!-- Chasis -->
        <rect x="5" y="56" width="125" height="8" fill="#37474f"/>
        <!-- Tambor giratorio -->
        <ellipse cx="88" cy="42" rx="38" ry="26" fill="#757575" stroke="#37474f" stroke-width="2"/>
        <ellipse cx="88" cy="42" rx="30" ry="20" fill="#9e9e9e"/>
        <path d="M 65 36 Q 88 26 111 36" stroke="#FFD700" stroke-width="3" fill="none"/>
        <path d="M 63 48 Q 88 42 113 48" stroke="#FFD700" stroke-width="3" fill="none"/>
        <!-- Canal salida -->
        <rect x="118" y="50" width="14" height="5" fill="#37474f" rx="1"/>
        <!-- Ruedas -->
        <circle cx="22"  cy="64" r="9" fill="#111"/><circle cx="22"  cy="64" r="4" fill="#555"/>
        <circle cx="50"  cy="64" r="9" fill="#111"/><circle cx="50"  cy="64" r="4" fill="#555"/>
        <circle cx="95"  cy="64" r="10" fill="#111"/><circle cx="95"  cy="64" r="4" fill="#555"/>
        <circle cx="116" cy="64" r="10" fill="#111"/><circle cx="116" cy="64" r="4" fill="#555"/>
      </svg>
    </div>

    <!-- INGENIERO CAMINANDO -->
    <div class="ingeniero">
      <svg viewBox="0 0 100 110">
        <!-- Casco amarillo con visera -->
        <ellipse cx="50" cy="25" rx="22" ry="20" fill="#FFD700"/>
        <rect x="28" y="34" width="44" height="6" fill="#FFA000" rx="2"/>
        <!-- Cara -->
        <circle cx="50" cy="46" r="13" fill="#FFCC99"/>
        <circle cx="45" cy="44" r="2" fill="#333"/>
        <circle cx="55" cy="44" r="2" fill="#333"/>
        <path d="M 45 51 Q 50 55 55 51" stroke="#333" stroke-width="1.5" fill="none"/>
        <!-- Cuerpo chaleco naranja -->
        <rect x="38" y="58" width="24" height="26" fill="#E65100" rx="3"/>
        <rect x="44" y="58" width="12" height="26" fill="#FF8F00" rx="2"/>
        <!-- Brazos -->
        <rect x="28" y="60" width="10" height="22" fill="#E65100" rx="3"/>
        <rect x="62" y="60" width="10" height="22" fill="#E65100" rx="3"/>
        <!-- Manos -->
        <circle cx="33" cy="83" r="5" fill="#FFCC99"/>
        <circle cx="67" cy="83" r="5" fill="#FFCC99"/>
        <!-- Piernas pantal√≥n gris -->
        <rect x="40" y="82" width="9"  height="22" fill="#546e7a" rx="3"/>
        <rect x="51" y="82" width="9"  height="22" fill="#546e7a" rx="3"/>
        <!-- Botas -->
        <rect x="38" y="100" width="13" height="8" fill="#333" rx="2"/>
        <rect x="49" y="100" width="13" height="8" fill="#333" rx="2"/>
        <!-- Portapapeles -->
        <rect x="62" y="70" width="14" height="18" fill="#fff" stroke="#aaa" stroke-width="1" rx="1"/>
        <line x1="64" y1="74" x2="74" y2="74" stroke="#aaa" stroke-width="1"/>
        <line x1="64" y1="77" x2="74" y2="77" stroke="#aaa" stroke-width="1"/>
        <line x1="64" y1="80" x2="74" y2="80" stroke="#aaa" stroke-width="1"/>
      </svg>
    </div>

    <div class="suelo"></div>
  </div>

  <h1>Registro Visita T√©cnica de Obra</h1>
  <h2 style="margin-top:4px;margin-bottom:4px;font-size:13px;color:var(--rojo);font-weight:700;line-height:1.4;">SECRETARIA DISTRITAL DE SEGURIDAD,<br>CONVIVENCIA Y JUSTICIA</h2>
  <h2 style="margin-top:6px;margin-bottom:2px;font-size:15px;">Direcci√≥n de Bienes</h2>
  <h2 style="margin-top:0;margin-bottom:16px;font-size:17px;font-weight:900;">2026</h2>
  <h2>Ingreso al Sistema</h2>
  <input type="text" id="usuarioInput" placeholder="Escriba su usuario" style="width:70%;margin:auto;display:block;">
  <button id="btnIngresar">Ingresar</button>
  <p style="font-size:11px;color:#999;margin-top:16px;">Desarrollado por: Ing. Johan Manuel Cardenas Leal, MSc</p>
</div>

<!-- ===== PANTALLA 1B: SELECCI√ìN MODO ===== -->
<div id="pantallaSeleccion" class="contenedor" style="display:none;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <button id="btnVolverLogin" class="btn-secundario" style="width:auto;padding:7px 14px;font-size:12px;margin:0;">&#8592; Cambiar Usuario</button>
    <h2 style="margin:0;flex:1;">Bienvenido, <span id="usuarioSeleccion" style="color:var(--rojo);"></span></h2>
  </div>
  <p style="color:#555;font-size:14px;margin-bottom:20px;">¬øQu√© desea hacer?</p>
  <div class="modo-card">
    <span class="modo-icon">üìÇ</span>
    <h3>Cargar sesi√≥n guardada</h3>
    <p>Contin√∫e donde lo dej√≥. Cargue un archivo .json exportado anteriormente.</p>
    <input type="file" id="inputCargarJSON" accept=".json" style="display:none;margin:0;">
    <button type="button" onclick="document.getElementById('inputCargarJSON').click()" style="margin-top:14px;">üìÇ Seleccionar archivo JSON</button>
  </div>
  <div class="modo-card nuevo">
    <span class="modo-icon">‚ûï</span>
    <h3>Generar nueva observaci√≥n</h3>
    <p>Inicie una nueva sesi√≥n, seleccione el proyecto y registre observaciones.</p>
    <button type="button" id="btnNuevaSesion" style="margin-top:14px;">‚ûï Nueva sesi√≥n</button>
  </div>
</div>

<!-- ===== PANTALLA 2: PROYECTO ===== -->
<div id="pantallaProyecto" class="contenedor" style="display:none;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <button id="btnVolverSeleccion" class="btn-secundario" style="width:auto;padding:7px 14px;font-size:12px;margin:0;">&#8592; Inicio</button>
    <h2 style="margin:0;flex:1;">Informaci√≥n del Proyecto</h2>
  </div>
  <p id="usuarioActivo" style="font-size:14px;color:#555;"></p>
  <label>Seleccione el Proyecto:</label>
  <select id="proyectoInput">
    <option value="">-- Seleccione un proyecto --</option>
    <option value="BRIGADA XIII">BRIGADA XIII</option>
    <option value="CAMPO VERDE">CAMPO VERDE</option>
    <option value="CER FASE II">CER FASE II</option>
    <option value="CTP">CTP</option>
    <option value="PREDIOS">PREDIOS</option>
    <option value="URI NORTE">URI NORTE</option>
    <option value="URI TUNJUELITO">URI TUNJUELITO</option>
  </select>
  <button id="btnGuardarProyecto">Continuar</button>
</div>

<!-- ===== PANTALLA 3: NUEVA OBSERVACI√ìN ===== -->
<div id="pantallaRegistro" class="contenedor" style="display:none;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <button id="btnRegresarProyecto" class="btn-secundario" style="width:auto;padding:7px 14px;font-size:12px;margin:0;">&#8592; Proyecto</button>
    <h2 style="margin:0;flex:1;font-size:1.1rem;">Nueva Observaci√≥n</h2>
  </div>
  <div class="info-proyecto">
    <strong>Proyecto:</strong> <span id="nombreProyectoDisplay"></span><br>
    <strong>Usuario:</strong> <span id="usuarioDisplay"></span>
  </div>
  <label>Fotos (m√°x. 4):</label>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
    <button type="button" onclick="document.getElementById('fotoInput').click()" class="btn-small" style="width:auto;flex:1;">üì∑ Tomar Foto</button>
    <button type="button" onclick="document.getElementById('galeriaInput').click()" class="btn-small btn-secundario" style="width:auto;flex:1;">üñºÔ∏è Galer√≠a</button>
  </div>
  <input type="file" accept="image/*" capture="environment" id="fotoInput" style="display:none;margin:0;">
  <input type="file" accept="image/*" id="galeriaInput" style="display:none;margin:0;">
  <span class="label-fotos-cantidad" id="labelCantFotos">0 / 4 fotos</span>
  <div id="previewFotos" class="fotos-container"></div>

  <label>Observaci√≥n:</label>
  <textarea id="observacion" rows="4" placeholder="Describa la observaci√≥n..."></textarea>

  <label>Disciplina:</label>
  <select id="disciplina">
    <option value="">Seleccione</option>
    <option>Arquitectura</option><option>Estructura</option><option>Electrica</option>
    <option>Hidraulica</option><option>HVAC</option><option>RCI</option>
    <option>Iluminacion</option><option>Seguridad Electronica</option><option>Comunicaciones</option>
  </select>

  <label>Lugar / Ubicaci√≥n:</label>
  <input type="text" id="lugar" placeholder="Ej: Piso 1 - Ba√±os administraci√≥n">

  <label>Responsable:</label>
  <input type="text" id="responsable" placeholder="Ej: Contratista / Interventor√≠a / Empresa">

  <label>Nivel de Impacto:</label>
  <select id="impacto">
    <option value="">Seleccione</option>
    <option>Bajo</option><option>Medio</option><option>Alto</option><option>Cr√≠tico</option>
  </select>

  <button id="btnAgregar">Agregar Observaci√≥n</button>
  <button id="btnVerObservaciones" class="btn-secundario">Ver Observaciones (<span id="contadorObs">0</span>)</button>
</div>

<!-- ===== PANTALLA 4: VER OBSERVACIONES ===== -->
<div id="pantallaObservaciones" class="contenedor" style="display:none;">
  <h2>Observaciones Registradas</h2>
  <div class="info-proyecto">
    <strong>Proyecto:</strong> <span id="nombreProyectoDisplay2"></span><br>
    <strong>Total:</strong> <span id="totalObs">0</span> observaciones
  </div>
  <div id="obsCard" class="obs-card"></div>
  <!-- Agregar fotos a observaci√≥n actual -->
  <div style="background:#fef9f9;border:1.5px dashed rgba(198,40,40,0.35);border-radius:10px;padding:12px 14px;margin:10px 0;">
    <p style="font-size:12px;color:#666;margin:0 0 8px;text-align:left;"><strong>Agregar fotos a esta observaci√≥n</strong> (m√°x. 4 total)</p>
    <div style="display:flex;gap:8px;">
      <button type="button" onclick="document.getElementById('addFotoInput').click()" class="btn-small" style="width:auto;flex:1;font-size:12px;">üì∑ C√°mara</button>
      <button type="button" onclick="document.getElementById('addGaleriaInput').click()" class="btn-small btn-secundario" style="width:auto;flex:1;font-size:12px;">üñºÔ∏è Galer√≠a</button>
    </div>
    <input type="file" id="addFotoInput"   accept="image/*" capture="environment" style="display:none;margin:0;">
    <input type="file" id="addGaleriaInput" accept="image/*" style="display:none;margin:0;">
    <span id="labelFotosObs" style="font-size:11px;color:#999;display:block;text-align:right;margin-top:4px;"></span>
  </div>
  <div class="nav-obs">
    <button id="btnObsAnterior">&#9664;</button>
    <span class="obs-indicator" id="obsIndicador">1 / 1</span>
    <button id="btnObsSiguiente">&#9654;</button>
  </div>
  <button id="btnVolverRegistro" class="btn-secundario">&#8592; Nueva Observaci√≥n</button>
  <button id="btnPDF">Exportar PDF</button>
  <button id="btnExportarJSON" class="btn-azul">Exportar JSON</button>
</div>

<script>
// === FONDO GEOM√âTRICO CANVAS (tetraedros / pol√≠gonos en rojo sutil) ===
(function() {
  var canvas = document.getElementById('geoCanvas');
  var ctx    = canvas.getContext('2d');
  var shapes = [];
  var NUM    = 18;

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // Tipos de figuras: tri√°ngulo, cuadrado rotado, hex√°gono, tetraedro (proyecci√≥n)
  function crearShape() {
    var tipos = ['tri','square','hex','tetra'];
    var tipo  = tipos[Math.floor(Math.random()*tipos.length)];
    return {
      tipo:   tipo,
      x:      Math.random()*window.innerWidth,
      y:      Math.random()*window.innerHeight,
      size:   30 + Math.random()*70,
      angle:  Math.random()*Math.PI*2,
      dAngle: (Math.random()-0.5)*0.008,
      alpha:  0,
      dAlpha: 0.002 + Math.random()*0.003,
      fadeIn: true,
      maxAlpha: 0.06 + Math.random()*0.08,
      vx:     (Math.random()-0.5)*0.3,
      vy:     (Math.random()-0.5)*0.3
    };
  }

  for (var i=0; i<NUM; i++) {
    var s = crearShape();
    s.alpha = Math.random()*s.maxAlpha; // iniciar en estado aleatorio
    shapes.push(s);
  }

  function drawTri(ctx, x, y, r, a) {
    ctx.beginPath();
    for (var i=0; i<3; i++) {
      var ang = a + (i*2*Math.PI/3) - Math.PI/2;
      i===0 ? ctx.moveTo(x+r*Math.cos(ang), y+r*Math.sin(ang))
            : ctx.lineTo(x+r*Math.cos(ang), y+r*Math.sin(ang));
    }
    ctx.closePath();
  }

  function drawSquare(ctx, x, y, r, a) {
    ctx.beginPath();
    for (var i=0; i<4; i++) {
      var ang = a + (i*Math.PI/2) + Math.PI/4;
      i===0 ? ctx.moveTo(x+r*Math.cos(ang), y+r*Math.sin(ang))
            : ctx.lineTo(x+r*Math.cos(ang), y+r*Math.sin(ang));
    }
    ctx.closePath();
  }

  function drawHex(ctx, x, y, r, a) {
    ctx.beginPath();
    for (var i=0; i<6; i++) {
      var ang = a + (i*Math.PI/3);
      i===0 ? ctx.moveTo(x+r*Math.cos(ang), y+r*Math.sin(ang))
            : ctx.lineTo(x+r*Math.cos(ang), y+r*Math.sin(ang));
    }
    ctx.closePath();
  }

  function drawTetra(ctx, x, y, r, a) {
    // Proyecci√≥n 2D de tetraedro: tri√°ngulo exterior + tri√°ngulo interior + l√≠neas
    drawTri(ctx, x, y, r, a);
    ctx.stroke();
    // Tri√°ngulo interior girado
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(a + Math.PI/3);
    ctx.beginPath();
    for (var i=0; i<3; i++) {
      var ang = (i*2*Math.PI/3) - Math.PI/2;
      i===0 ? ctx.moveTo(r*0.45*Math.cos(ang), r*0.45*Math.sin(ang))
            : ctx.lineTo(r*0.45*Math.cos(ang), r*0.45*Math.sin(ang));
    }
    ctx.closePath();
    ctx.stroke();
    // L√≠neas del v√©rtice al centro
    for (var i=0; i<3; i++) {
      var ang = (i*2*Math.PI/3) - Math.PI/2;
      ctx.beginPath();
      ctx.moveTo(r*Math.cos(ang + a - (a)), r*Math.sin(ang + a - (a)));
      ctx.lineTo(0,0);
      ctx.stroke();
    }
    ctx.restore();
  }

  function animate() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    shapes.forEach(function(s) {
      // Alpha fade
      if (s.fadeIn) { s.alpha += s.dAlpha; if (s.alpha >= s.maxAlpha) s.fadeIn=false; }
      else          { s.alpha -= s.dAlpha*0.5; if (s.alpha <= 0) { Object.assign(s, crearShape()); s.alpha=0; s.fadeIn=true; } }

      s.angle += s.dAngle;
      s.x += s.vx; s.y += s.vy;
      // Rebote suave
      if (s.x < -100) s.x = canvas.width+100;
      if (s.x > canvas.width+100)  s.x = -100;
      if (s.y < -100) s.y = canvas.height+100;
      if (s.y > canvas.height+100) s.y = -100;

      ctx.save();
      ctx.strokeStyle = 'rgba(198,40,40,' + s.alpha + ')';
      ctx.lineWidth   = 1.5;
      ctx.fillStyle   = 'transparent';

      if (s.tipo==='tri')    { drawTri(ctx,s.x,s.y,s.size,s.angle);    ctx.stroke(); }
      else if (s.tipo==='square') { drawSquare(ctx,s.x,s.y,s.size,s.angle); ctx.stroke(); }
      else if (s.tipo==='hex')  { drawHex(ctx,s.x,s.y,s.size,s.angle);    ctx.stroke(); }
      else if (s.tipo==='tetra'){ drawTetra(ctx,s.x,s.y,s.size,s.angle); }

      ctx.restore();
    });

    requestAnimationFrame(animate);
  }
  animate();
})();

// ============================================================
document.addEventListener("DOMContentLoaded", function() {

  var usuariosPermitidos = [
    "johan","johan.cardenas","luis.ramirez","david.barrios",
    "nicolas.rodriguez","sebastian.beleno","andres.hernandez","gabriel.mayorga"
  ];
  var usuarioActivo="", nombreProyecto="", registros=[], fotosActuales=[];
  var obsIndex=0, fotoIndex=0;

  var siglasProyecto = {
    'CER FASE II':'CPA','URI NORTE':'URN','URI TUNJUELITO':'URT',
    'CTP':'CTP','CAMPO VERDE':'CMV','BRIGADA XIII':'BRI','PREDIOS':'AVP'
  };

  // Colores por disciplina (para gr√°ficas)
  var coloresDisc = {
    'Arquitectura':[198,40,40],'Estructura':[21,101,192],'Electrica':[255,160,0],
    'Hidraulica':[0,150,136],'HVAC':[123,31,162],'RCI':[211,47,47],
    'Iluminacion':[251,192,45],'Seguridad Electronica':[55,71,79],'Comunicaciones':[46,125,50]
  };

  function ir(id) {
    ['pantallaLogin','pantallaSeleccion','pantallaProyecto','pantallaRegistro','pantallaObservaciones']
      .forEach(function(p){ document.getElementById(p).style.display='none'; });
    document.getElementById(id).style.display='block';
  }

  // LOGIN
  document.getElementById("btnIngresar").addEventListener("click", function() {
    var u = document.getElementById("usuarioInput").value.trim().toLowerCase();
    if (usuariosPermitidos.indexOf(u)>=0) {
      usuarioActivo=u;
      document.getElementById("usuarioSeleccion").innerText=u;
      ir('pantallaSeleccion');
    } else { alert("Usuario no autorizado"); }
  });

  // CARGAR JSON
  document.getElementById("inputCargarJSON").addEventListener("change", function(e) {
    var file=e.target.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(ev){
      try {
        var datos=JSON.parse(ev.target.result);
        if(datos.registros && Array.isArray(datos.registros)){
          registros=datos.registros;
          if(datos.proyecto) nombreProyecto=datos.proyecto;
          if(datos.usuario)  usuarioActivo=datos.usuario;
          document.getElementById("nombreProyectoDisplay").innerText=nombreProyecto;
          document.getElementById("usuarioDisplay").innerText=formatearUsuario(usuarioActivo);
          actualizarContador();
          alert("Sesion cargada: "+registros.length+" observaciones del proyecto "+nombreProyecto);
          ir('pantallaRegistro');
        } else { alert("Archivo JSON invalido"); }
      } catch(err){ alert("Error al leer el archivo JSON"); }
    };
    reader.readAsText(file); e.target.value="";
  });

  // Formatea usuario: "johan.cardenas" -> "JOHAN CARDENAS"
  function formatearUsuario(u) {
    return u.replace(/\./g,' ').toUpperCase();
  }

  // NUEVA SESI√ìN
  document.getElementById("btnNuevaSesion").addEventListener("click", function() {
    registros=[]; fotosActuales=[]; nombreProyecto="";
    document.getElementById("usuarioActivo").innerText="Usuario: "+formatearUsuario(usuarioActivo);
    ir('pantallaProyecto');
  });

  // VOLVER AL LOGIN (pantalla 1)
  document.getElementById("btnVolverLogin").addEventListener("click", function() {
    document.getElementById("usuarioInput").value = "";
    usuarioActivo = "";
    ir('pantallaLogin');
  });

  // VOLVER A SELECCI√ìN DE MODO (pantalla 1B)
  document.getElementById("btnVolverSeleccion").addEventListener("click", function() {
    ir('pantallaSeleccion');
  });

  // REGRESAR A SELECCI√ìN DE PROYECTO (pantalla 2)
  document.getElementById("btnRegresarProyecto").addEventListener("click", function() {
    ir('pantallaProyecto');
  });

  // PROYECTO
  document.getElementById("btnGuardarProyecto").addEventListener("click", function() {
    var p=document.getElementById("proyectoInput").value.trim();
    if(!p){ alert("Debe seleccionar el proyecto"); return; }
    nombreProyecto=p;
    document.getElementById("nombreProyectoDisplay").innerText=p;
    document.getElementById("usuarioDisplay").innerText=formatearUsuario(usuarioActivo);
    ir('pantallaRegistro');
  });

  // FOTOS
  document.getElementById("fotoInput").addEventListener("change",function(e){ manejarFoto(e.target.files[0]); e.target.value=""; });
  document.getElementById("galeriaInput").addEventListener("change",function(e){ manejarFoto(e.target.files[0]); e.target.value=""; });

  function manejarFoto(file){
    if(!file) return;
    if(fotosActuales.length>=4){ alert("Maximo 4 fotos"); return; }
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        function(pos){ procesarFoto(file,pos); },
        function(){     procesarFoto(file,null); }
      );
    } else { procesarFoto(file,null); }
  }

  function procesarFoto(file,position){
    var reader=new FileReader();
    reader.onload=function(e){
      var img=new Image();
      img.onload=function(){
        var canvas=document.createElement('canvas');
        var ctx=canvas.getContext('2d');
        canvas.width=img.width; canvas.height=img.height;
        ctx.drawImage(img,0,0);
        // Marca agua
        ctx.save();
        ctx.translate(canvas.width/2,canvas.height/2);
        ctx.rotate(-45*Math.PI/180);
        var mws=Math.min(canvas.width,canvas.height)/15;
        ctx.font='bold '+mws+'px Arial';
        ctx.fillStyle='rgba(220,220,220,0.45)';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ['SECRETARIA DISTRITAL DE','SEGURIDAD, CONVIVENCIA','Y JUSTICIA'].forEach(function(t,i){
          ctx.fillText(t,0,(i-1)*mws*1.2);
        });
        ctx.restore();
        // Metadata
        var f=new Date();
        var pad=function(n){ return String(n).padStart(2,'0'); };
        var fs=pad(f.getDate())+'/'+pad(f.getMonth()+1)+'/'+f.getFullYear()+' '+pad(f.getHours())+':'+pad(f.getMinutes());
        var meta=[fs];
        if(position) meta.push(position.coords.latitude.toFixed(5)+','+position.coords.longitude.toFixed(5));
        else meta.push('Sin GPS');
        meta.push('Bogota, Colombia'); meta.push(nombreProyecto); meta.push('Usuario: '+usuarioActivo);
        var fsz=Math.min(canvas.width,canvas.height)/40;
        ctx.textAlign='right'; ctx.font='bold '+fsz+'px Arial';
        var yp=fsz+40;
        meta.forEach(function(linea){
          ctx.fillStyle='rgba(0,0,0,0.75)';
          ctx.fillText(linea,canvas.width-18,yp+2);
          ctx.fillText(linea,canvas.width-22,yp+2);
          ctx.fillStyle='#FFF';
          ctx.fillText(linea,canvas.width-20,yp);
          yp+=fsz*1.3;
        });
        var dataUrl=canvas.toDataURL('image/jpeg',0.92);
        fotosActuales.push(dataUrl);
        actualizarPreviewFotos();
        try{ var a=document.createElement('a'); a.download='VisitaObra_'+Date.now()+'.jpg'; a.href=dataUrl; document.body.appendChild(a); a.click(); document.body.removeChild(a); }catch(e){}
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function actualizarPreviewFotos(){
    var cont=document.getElementById("previewFotos");
    cont.innerHTML="";
    document.getElementById("labelCantFotos").innerText=fotosActuales.length+" / 4 fotos";
    fotosActuales.forEach(function(src,i){
      var div=document.createElement('div'); div.className='foto-item';
      div.innerHTML='<img src="'+src+'" alt="Foto '+(i+1)+'"><button class="btn-eliminar-foto" onclick="eliminarFotoActual('+i+')">X Eliminar</button>';
      cont.appendChild(div);
    });
  }

  window.eliminarFotoActual=function(i){ fotosActuales.splice(i,1); actualizarPreviewFotos(); };

  // AGREGAR OBSERVACI√ìN
  document.getElementById("btnAgregar").addEventListener("click", function() {
    var obs=document.getElementById("observacion").value.trim();
    var dis=document.getElementById("disciplina").value;
    var lug=document.getElementById("lugar").value.trim();
    var res=document.getElementById("responsable").value.trim();
    var imp=document.getElementById("impacto").value;
    if(fotosActuales.length===0||!obs||!dis||!lug||!res||!imp){ alert("Complete todos los campos y agregue al menos una foto"); return; }
    registros.push({ usuario:usuarioActivo, proyecto:nombreProyecto, fecha:new Date().toLocaleString('es-CO'),
      fotos:fotosActuales.slice(), observacion:obs, disciplina:dis, lugar:lug, responsable:res, impacto:imp });
    actualizarContador(); alert("Observacion agregada"); limpiarFormulario();
  });

  function limpiarFormulario(){
    ['observacion','disciplina','lugar','responsable','impacto'].forEach(function(id){ document.getElementById(id).value=""; });
    document.getElementById("previewFotos").innerHTML="";
    document.getElementById("labelCantFotos").innerText="0 / 4 fotos";
    fotosActuales=[];
  }
  function actualizarContador(){ document.getElementById("contadorObs").innerText=registros.length; }

  // VER OBSERVACIONES
  document.getElementById("btnVerObservaciones").addEventListener("click",function(){
    if(registros.length===0){ alert("No hay observaciones"); return; }
    document.getElementById("nombreProyectoDisplay2").innerText=nombreProyecto;
    document.getElementById("totalObs").innerText=registros.length;
    obsIndex=0; fotoIndex=0;
    ir('pantallaObservaciones'); renderCarrusel();
  });
  document.getElementById("btnVolverRegistro").addEventListener("click",function(){ ir('pantallaRegistro'); actualizarContador(); });

  // CARRUSEL
  document.getElementById("btnObsAnterior").addEventListener("click",function(){ if(obsIndex>0){obsIndex--;fotoIndex=0;renderCarrusel();} });
  document.getElementById("btnObsSiguiente").addEventListener("click",function(){ if(obsIndex<registros.length-1){obsIndex++;fotoIndex=0;renderCarrusel();} });

  function renderCarrusel(){
    var r=registros[obsIndex]; var total=registros.length;
    var fotos=r.fotos||(r.foto?[r.foto]:[]);
    document.getElementById("obsIndicador").innerText=(obsIndex+1)+' / '+total;
    document.getElementById("btnObsAnterior").disabled=(obsIndex===0);
    document.getElementById("btnObsSiguiente").disabled=(obsIndex===total-1);
    var ci={'Critico':'impacto-critico','Cr√≠tico':'impacto-critico','Alto':'impacto-alto','Medio':'impacto-medio','Bajo':'impacto-bajo'}[r.impacto]||'';
    var fHTML='';
    if(fotos.length>0){
      fHTML='<div class="carrusel-fotos"><img src="'+fotos[fotoIndex]+'" alt="Foto '+(fotoIndex+1)+'">'
        +'<div class="nav-fotos">'
        +'<button '+(fotoIndex===0?'disabled':'')+' onclick="cambiarFoto(-1)">&#9664;</button>'
        +'<span class="foto-indicator">Foto '+(fotoIndex+1)+' de '+fotos.length+'</span>'
        +'<button '+(fotoIndex===fotos.length-1?'disabled':'')+' onclick="cambiarFoto(1)">&#9654;</button>'
        +'</div><div class="fotos-barra">'
        +fotos.map(function(_,i){ return '<span class="'+(i===fotoIndex?'activo':'')+'"></span>'; }).join('')
        +'</div></div>';
    }
    var resp=r.responsable?'<p><strong>Responsable:</strong> '+r.responsable+'</p>':'';
    actualizarLabelFotosObs(r);
    document.getElementById("obsCard").innerHTML=
      '<h3>Observacion #'+(obsIndex+1)+'</h3>'
      +'<p><strong>Fecha:</strong> '+r.fecha+'</p>'
      +'<p><strong>Disciplina:</strong> '+r.disciplina+'</p>'
      +'<p><strong>Lugar:</strong> '+r.lugar+'</p>'
      +resp
      +'<p><strong>Impacto:</strong> <span class="'+ci+'">'+r.impacto+'</span></p>'
      +fHTML
      +'<p style="margin-top:10px;"><strong>Descripcion:</strong></p><p>'+r.observacion+'</p>'
      +'<button onclick="toggleEditar('+obsIndex+')" class="btn-small btn-secundario" style="width:auto;margin-top:10px;">Editar observacion</button>'
      +'<div id="editArea_'+obsIndex+'" class="obs-edit-area">'
      +'<label>Observacion:</label><textarea id="editObs_'+obsIndex+'" rows="3">'+r.observacion+'</textarea>'
      +'<label>Disciplina:</label><select id="editDisc_'+obsIndex+'">'
      +['Arquitectura','Estructura','Electrica','Hidraulica','HVAC','RCI','Iluminacion','Seguridad Electronica','Comunicaciones'].map(function(d){ return '<option '+(d===r.disciplina?'selected':'')+'>'+d+'</option>'; }).join('')
      +'</select>'
      +'<label>Lugar:</label><input type="text" id="editLugar_'+obsIndex+'" value="'+r.lugar+'">'
      +'<label>Responsable:</label><input type="text" id="editResp_'+obsIndex+'" value="'+(r.responsable||'')+'">'
      +'<label>Impacto:</label><select id="editImpacto_'+obsIndex+'">'
      +['Bajo','Medio','Alto','Cr√≠tico'].map(function(imp){ return '<option '+(imp===r.impacto?'selected':'')+'>'+imp+'</option>'; }).join('')
      +'</select>'
      +'<button onclick="guardarEdicion('+obsIndex+')" style="margin-top:6px;">Guardar cambios</button>'
      +'</div>';
  }

  window.cambiarFoto=function(dir){ var r=registros[obsIndex]; var fotos=r.fotos||(r.foto?[r.foto]:[]); fotoIndex=Math.max(0,Math.min(fotos.length-1,fotoIndex+dir)); renderCarrusel(); };
  window.toggleEditar=function(idx){ var a=document.getElementById('editArea_'+idx); if(a) a.classList.toggle('activo'); };
  window.guardarEdicion=function(idx){
    registros[idx].observacion=document.getElementById('editObs_'+idx).value.trim();
    registros[idx].disciplina=document.getElementById('editDisc_'+idx).value;
    registros[idx].lugar=document.getElementById('editLugar_'+idx).value.trim();
    registros[idx].responsable=document.getElementById('editResp_'+idx).value.trim();
    registros[idx].impacto=document.getElementById('editImpacto_'+idx).value;
    alert("Cambios guardados"); renderCarrusel();
  };

  // EXPORTAR JSON
  document.getElementById("btnExportarJSON").addEventListener("click",function(){
    if(registros.length===0){ alert("No hay registros"); return; }
    var datos={proyecto:nombreProyecto,usuario:usuarioActivo,fecha:new Date().toLocaleString('es-CO'),registros:registros};
    var blob=new Blob([JSON.stringify(datos,null,2)],{type:'application/json'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download='SCJ-VIS-TEC-'+(siglasProyecto[nombreProyecto]||'PRY')+'.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });

  // ============================================================
  // EXPORTAR PDF
  // ============================================================
  // AGREGAR FOTOS A OBSERVACI√ìN EXISTENTE
  function setupAddFotos() {
    ['addFotoInput','addGaleriaInput'].forEach(function(id) {
      document.getElementById(id).addEventListener("change", function(e) {
        var file = e.target.files[0]; if(!file) return;
        var r = registros[obsIndex];
        var fotos = r.fotos || (r.foto ? [r.foto] : []);
        if(fotos.length >= 4) { alert("Esta observacion ya tiene 4 fotos (maximo)"); e.target.value=""; return; }
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(pos){ procesarFotoObs(file, pos, r); },
            function(){    procesarFotoObs(file, null, r); }
          );
        } else { procesarFotoObs(file, null, r); }
        e.target.value="";
      });
    });
  }
  setupAddFotos();

  function procesarFotoObs(file, position, r) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width=img.width; canvas.height=img.height;
        ctx.drawImage(img,0,0);
        ctx.save();
        ctx.translate(canvas.width/2,canvas.height/2);
        ctx.rotate(-45*Math.PI/180);
        var mws=Math.min(canvas.width,canvas.height)/15;
        ctx.font='bold '+mws+'px Arial'; ctx.fillStyle='rgba(220,220,220,0.45)';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ['SECRETARIA DISTRITAL DE','SEGURIDAD, CONVIVENCIA','Y JUSTICIA'].forEach(function(t,i){
          ctx.fillText(t,0,(i-1)*mws*1.2);
        });
        ctx.restore();
        var f=new Date(), pad=function(n){return String(n).padStart(2,'0');};
        var meta=[pad(f.getDate())+'/'+pad(f.getMonth()+1)+'/'+f.getFullYear()+' '+pad(f.getHours())+':'+pad(f.getMinutes())];
        if(position) meta.push(position.coords.latitude.toFixed(5)+','+position.coords.longitude.toFixed(5));
        else meta.push('Sin GPS');
        meta.push('Bogota, Colombia'); meta.push(nombreProyecto);
        var fsz=Math.min(canvas.width,canvas.height)/40;
        ctx.textAlign='right'; ctx.font='bold '+fsz+'px Arial';
        var yp=fsz+40;
        meta.forEach(function(linea){
          ctx.fillStyle='rgba(0,0,0,0.75)'; ctx.fillText(linea,canvas.width-18,yp+2); ctx.fillText(linea,canvas.width-22,yp+2);
          ctx.fillStyle='#FFF'; ctx.fillText(linea,canvas.width-20,yp); yp+=fsz*1.3;
        });
        var dataUrl=canvas.toDataURL('image/jpeg',0.92);
        if(!r.fotos) r.fotos=[];
        r.fotos.push(dataUrl);
        try{ var a=document.createElement('a'); a.download='VisitaObra_'+Date.now()+'.jpg'; a.href=dataUrl; document.body.appendChild(a); a.click(); document.body.removeChild(a); }catch(ex){}
        fotoIndex=r.fotos.length-1;
        renderCarrusel();
        actualizarLabelFotosObs(r);
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function actualizarLabelFotosObs(r) {
    var fotos=r.fotos||(r.foto?[r.foto]:[]);
    var lbl=document.getElementById('labelFotosObs');
    if(lbl) lbl.innerText=fotos.length+' / 4 fotos en esta observaci√≥n';
  }

  document.getElementById("btnPDF").addEventListener("click",function(){
    if(registros.length===0){ alert("No hay registros"); return; }
    var jsPDF=window.jspdf.jsPDF;
    var doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    var pw=210, ph=297, mB=18;

    function enc(){
      doc.setFillColor(198,40,40); doc.rect(0,0,pw,9,'F');
      doc.setFontSize(9); doc.setFont(undefined,'bold'); doc.setTextColor(255,255,255);
      doc.text("SECRETARIA DISTRITAL DE SEGURIDAD, CONVIVENCIA Y JUSTICIA",pw/2,6,{align:'center'});
      doc.setTextColor(0,0,0);
    }
    function pie(pag,total){
      doc.setDrawColor(180,180,180); doc.setLineWidth(0.3);
      doc.line(20,ph-13,pw-20,ph-13);
      doc.setFontSize(8); doc.setTextColor(120,120,120);
      doc.text("Pagina "+pag+" de "+total,pw/2,ph-8,{align:'center'});
      doc.setFontSize(7);
      doc.text("Desarrollado por: Ing. Johan Manuel Cardenas Leal, MSc",pw/2,ph-4,{align:'center'});
      doc.setTextColor(0,0,0);
    }

    var totalPags=1+registros.length+1+1; // portada + obs + stats + matriz
    var y=0;

    // ===== PORTADA - layout con coordenadas absolutas fijas =====
    enc();

    // La p√°gina A4 mide 297mm alto. Encabezado rojo ocupa y=0..9
    // Distribuimos en 4 zonas verticales bien separadas:
    // ZONA 1 (y=20..30):  T√≠tulo
    // ZONA 2 (y=35..110): Recuadro info proyecto
    // ZONA 3 (y=118..150): Firmas
    // ZONA 4 (y=158..200): Secretaria / Direccion / A√±o
    // Pie de p√°gina en y=280..297

    // ZONA 1 ‚Äî T√≠tulo
    doc.setFontSize(18); doc.setFont(undefined,'bold'); doc.setTextColor(0,0,0);
    doc.text("REPORTE DE VISITA TECNICA DE OBRA", pw/2, 24, {align:'center'});

    // ZONA 2 ‚Äî Recuadro (y=32, h=76)
    doc.setFillColor(252,248,248); doc.setDrawColor(198,40,40); doc.setLineWidth(0.5);
    doc.roundedRect(18, 30, 174, 80, 3, 3, 'FD');

    doc.setFontSize(11); doc.setFont(undefined,'bold'); doc.setTextColor(198,40,40);
    doc.text("INFORMACION DEL PROYECTO", 28, 40);

    doc.setFontSize(10); doc.setTextColor(0,0,0);
    var filas2=[
      {k:"Proyecto:",      v:nombreProyecto},
      {k:"Profesional:",   v:formatearUsuario(usuarioActivo)},
      {k:"Rol:",           v:"Contratista Apoyo a la Supervision Tecnica"},
      {k:"Fecha:",         v:new Date().toLocaleString('es-CO')},
      {k:"Observaciones:", v:String(registros.length)}
    ];
    var ry2=50;
    filas2.forEach(function(f){
      doc.setFont(undefined,'bold');   doc.text(f.k, 28, ry2);
      doc.setFont(undefined,'normal'); doc.text(f.v, 68, ry2);
      ry2+=10;
    });

    // ZONA 3 ‚Äî Firmas (fijas en y=122)
    doc.setDrawColor(220,220,220); doc.setLineWidth(0.3);
    doc.line(30, 117, 180, 117);

    doc.setFontSize(9); doc.setFont(undefined,'bold'); doc.setTextColor(0,0,0);
    doc.text("ING. RICHARD OSVALDO GONZALEZ VERA", pw/2, 126, {align:'center'});
    doc.setFont(undefined,'normal'); doc.setFontSize(8);
    doc.text("DIRECTOR DE BIENES", pw/2, 132, {align:'center'});

    doc.setFont(undefined,'bold'); doc.setFontSize(9);
    doc.text("DRA. NATALIA ROMAN DUQUE", pw/2, 144, {align:'center'});
    doc.setFont(undefined,'normal'); doc.setFontSize(7.5);
    doc.text("SUBSECRETARIA DE INVERSIONES Y FORTALECIMIENTO DE CAPACIDADES OPERATIVAS", pw/2, 150, {align:'center'});

    // ZONA 4 ‚Äî Secretaria / Direccion / A√±o (fijas en y=162)
    doc.setDrawColor(198,40,40); doc.setLineWidth(0.6);
    doc.line(30, 158, 180, 158);

    doc.setFontSize(12); doc.setFont(undefined,'bold'); doc.setTextColor(198,40,40);
    doc.text("SECRETARIA DISTRITAL DE SEGURIDAD,", pw/2, 168, {align:'center'});
    doc.text("CONVIVENCIA Y JUSTICIA",              pw/2, 176, {align:'center'});

    doc.setFontSize(11); doc.setFont(undefined,'normal'); doc.setTextColor(0,0,0);
    doc.text("Direccion de Bienes", pw/2, 186, {align:'center'});
    doc.setFont(undefined,'bold'); doc.setFontSize(14);
    doc.text("2026", pw/2, 195, {align:'center'});

    pie(1,totalPags);

    // ===== OBSERVACIONES =====
    registros.forEach(function(r,idx){
      doc.addPage(); enc();
      var pag=idx+2; y=18;
      // T√≠tulo
      doc.setFillColor(198,40,40); doc.rect(10,y,190,11,'F');
      doc.setFontSize(12); doc.setFont(undefined,'bold'); doc.setTextColor(255,255,255);
      doc.text("OBSERVACION #"+(idx+1),15,y+7.5); doc.setTextColor(0,0,0); y+=17;

      var fotos=r.fotos||(r.foto?[r.foto]:[]);
      var nFotos=Math.min(fotos.length,4);
      var lugarLines=doc.splitTextToSize(r.lugar||'-',150);
      var infoH=52+(lugarLines.length-1)*5;

      doc.setFillColor(250,250,250); doc.setDrawColor(220,220,220); doc.setLineWidth(0.3);
      doc.roundedRect(10,y,190,infoH,2,2,'FD'); y+=7;

      doc.setFontSize(9.5);
      [["Fecha:",r.fecha],["Usuario:",r.usuario]].forEach(function(kv){
        doc.setFont(undefined,'bold'); doc.text(kv[0],15,y);
        doc.setFont(undefined,'normal'); doc.text(kv[1],35,y); y+=6;
      });
      doc.setFont(undefined,'bold'); doc.text("Disciplina:",15,y);
      doc.setFont(undefined,'normal'); doc.text(r.disciplina,38,y);
      doc.setFont(undefined,'bold'); doc.text("Impacto:",115,y);
      var ci={'Critico':[198,40,40],'Cr√≠tico':[198,40,40],'Alto':[255,140,0],'Medio':[200,140,0],'Bajo':[46,125,50]}[r.impacto]||[0,0,0];
      doc.setTextColor(ci[0],ci[1],ci[2]); doc.setFont(undefined,'bold');
      doc.text(r.impacto,133,y); doc.setTextColor(0,0,0); y+=6;
      doc.setFont(undefined,'bold'); doc.text("Responsable:",15,y);
      doc.setFont(undefined,'normal'); doc.text(r.responsable||'-',43,y); y+=6;
      doc.setFont(undefined,'bold'); doc.text("Lugar:",15,y);
      doc.setFont(undefined,'normal'); doc.text(lugarLines,32,y);
      y+=6+(lugarLines.length-1)*5+8;

      // ===== FOTOS LAYOUT =====
      var limitY=ph-mB-16;

      if(nFotos===1){
        var iw=178, ih=130, ix=(pw-iw)/2;
        doc.setDrawColor(200,200,200); doc.setLineWidth(0.5);
        doc.rect(ix,y,iw,ih,'S');
        try{ doc.addImage(fotos[0],"JPEG",ix,y,iw,ih); }catch(e){}
        y+=ih+8;
      }
      else if(nFotos===2){
        // Izquierda | Derecha
        var iw=89, ih=67;
        [[11,y],[111,y]].forEach(function(pos,i){
          doc.setDrawColor(200,200,200); doc.rect(pos[0],pos[1],iw,ih,'S');
          try{ doc.addImage(fotos[i],"JPEG",pos[0],pos[1],iw,ih); }catch(e){}
        });
        y+=ih+8;
      }
      else if(nFotos===3){
        // Fila 1: Izquierda | Derecha
        var iw=89, ih=67;
        [[11,y],[111,y]].forEach(function(pos,i){
          doc.setDrawColor(200,200,200); doc.rect(pos[0],pos[1],iw,ih,'S');
          try{ doc.addImage(fotos[i],"JPEG",pos[0],pos[1],iw,ih); }catch(e){}
        });
        y+=ih+5;
        // Fila 2: centrada
        var iw2=89, ih2=67, ix2=(pw-iw2)/2;
        doc.setDrawColor(200,200,200); doc.rect(ix2,y,iw2,ih2,'S');
        try{ doc.addImage(fotos[2],"JPEG",ix2,y,iw2,ih2); }catch(e){}
        y+=ih2+8;
      }
      else if(nFotos===4){
        // 2x2 grid
        var iw=89, ih=63;
        [[11,y],[111,y]].forEach(function(pos,i){
          doc.setDrawColor(200,200,200); doc.rect(pos[0],pos[1],iw,ih,'S');
          try{ doc.addImage(fotos[i],"JPEG",pos[0],pos[1],iw,ih); }catch(e){}
        });
        y+=ih+4;
        [[11,y],[111,y]].forEach(function(pos,i){
          doc.setDrawColor(200,200,200); doc.rect(pos[0],pos[1],iw,ih,'S');
          try{ doc.addImage(fotos[i+2],"JPEG",pos[0],pos[1],iw,ih); }catch(e){}
        });
        y+=ih+8;
      }

      // Observaci√≥n
      var obsLines=doc.splitTextToSize(r.observacion||'-',175);
      if(y+25>limitY){ doc.addPage(); enc(); y=18; }
      var availH=limitY-y;
      doc.setFillColor(250,250,250); doc.setDrawColor(220,220,220);
      doc.roundedRect(10,y,190,availH,2,2,'FD'); y+=9;
      doc.setFont(undefined,'bold'); doc.setFontSize(10.5);
      doc.text("OBSERVACION:",15,y); y+=6;
      doc.setFont(undefined,'normal'); doc.setFontSize(10);
      doc.text(obsLines,15,y);
      pie(pag,totalPags);
    });

    // ===== ESTAD√çSTICAS =====
    doc.addPage(); enc();
    var pagEst=registros.length+2; y=18;
    doc.setFillColor(198,40,40); doc.rect(10,y,190,11,'F');
    doc.setFontSize(12); doc.setFont(undefined,'bold'); doc.setTextColor(255,255,255);
    doc.text("ESTADISTICAS DEL PROYECTO",pw/2,y+7.5,{align:'center'});
    doc.setTextColor(0,0,0); y+=20;

    var porDisc={}, porImp={}, porDI={};
    registros.forEach(function(r){
      porDisc[r.disciplina]=(porDisc[r.disciplina]||0)+1;
      porImp[r.impacto]=(porImp[r.impacto]||0)+1;
      var k=r.disciplina+'-'+r.impacto; porDI[k]=(porDI[k]||0)+1;
    });

    // --- Gr√°fica 1: Barras por Disciplina con color propio ---
    doc.setFontSize(10); doc.setFont(undefined,'bold');
    doc.text("Observaciones por Disciplina",pw/2,y,{align:'center'}); y+=8;

    var discKeys=Object.keys(porDisc);
    var maxC=Math.max(1,Math.max.apply(null,discKeys.map(function(k){ return porDisc[k]; })));
    var bw=Math.min(18, Math.floor(170/Math.max(discKeys.length,1))-3);
    var maxBH=38;
    var totalBW=discKeys.length*(bw+3)-3;
    var xb=(pw-totalBW)/2;

    discKeys.forEach(function(d){
      var c=porDisc[d];
      var bh=(c/maxC)*maxBH;
      var col=coloresDisc[d]||[100,100,100];
      doc.setFillColor(col[0],col[1],col[2]);
      doc.rect(xb,y+maxBH-bh,bw,bh,'F');
      doc.setFontSize(7); doc.setFont(undefined,'bold'); doc.setTextColor(col[0],col[1],col[2]);
      doc.text(String(c),xb+bw/2,y+maxBH-bh-2,{align:'center'});
      doc.setTextColor(80,80,80); doc.setFont(undefined,'normal'); doc.setFontSize(5.5);
      var lbl=doc.splitTextToSize(d,bw+4);
      lbl.forEach(function(l,li){ doc.text(l,xb+bw/2,y+maxBH+4+li*3.5,{align:'center'}); });
      xb+=bw+3;
    });
    doc.setTextColor(0,0,0); y+=maxBH+18;

    // --- Gr√°fica 2: Barras agrupadas por Impacto/Disciplina ---
    doc.setFontSize(10); doc.setFont(undefined,'bold');
    doc.text("Observaciones por Impacto segun Disciplina",pw/2,y,{align:'center'}); y+=8;

    var impactos=['Bajo','Medio','Alto','Cr√≠tico'];
    var colImpacto={'Bajo':[46,125,50],'Medio':[200,140,0],'Alto':[255,140,0],'Cr√≠tico':[198,40,40]};
    var bwImp=Math.min(14, Math.floor(170/(discKeys.length*impactos.length+impactos.length)));
    var gap=4;
    var groupW=discKeys.length*bwImp;
    var totalImpW=impactos.length*(groupW+gap)-gap;
    var xi=(pw-totalImpW)/2;
    var maxBH2=35;
    var maxCI=Math.max(1,Math.max.apply(null,Object.values(porDI)));

    impactos.forEach(function(imp){
      // Label impacto centrado sobre el grupo
      var col=colImpacto[imp];
      doc.setFontSize(6); doc.setFont(undefined,'bold'); doc.setTextColor(col[0],col[1],col[2]);
      doc.text(imp,xi+groupW/2,y+maxBH2+5,{align:'center'});
      doc.setTextColor(0,0,0);
      discKeys.forEach(function(d,di){
        var k=d+'-'+imp; var cnt=porDI[k]||0;
        var bh=(cnt/maxCI)*maxBH2;
        var dc=coloresDisc[d]||[100,100,100];
        doc.setFillColor(dc[0],dc[1],dc[2]);
        if(bh>0){
          doc.rect(xi+di*bwImp,y+maxBH2-bh,bwImp-1,bh,'F');
          doc.setFontSize(5.5); doc.setFont(undefined,'bold');
          doc.setTextColor(dc[0],dc[1],dc[2]);
          doc.text(String(cnt),xi+di*bwImp+(bwImp-1)/2,y+maxBH2-bh-1.5,{align:'center'});
          doc.setTextColor(0,0,0);
        }
      });
      xi+=groupW+gap;
    });

    y+=maxBH2+14;

    // Leyenda disciplinas
    doc.setFontSize(7); doc.setFont(undefined,'normal'); doc.setTextColor(60,60,60);
    var lx=12; var ly=y;
    discKeys.forEach(function(d,i){
      var col=coloresDisc[d]||[100,100,100];
      doc.setFillColor(col[0],col[1],col[2]);
      doc.rect(lx,ly-3,5,4,'F');
      doc.setTextColor(40,40,40);
      doc.text(d,lx+6,ly);
      lx+=doc.getTextWidth(d)+14;
      if(lx>185){ lx=12; ly+=6; }
    });
    y=ly+8; doc.setTextColor(0,0,0);

    // Tabla disc x impacto
    doc.setFontSize(10); doc.setFont(undefined,'bold');
    doc.text("Detalle: Disciplina vs Impacto",pw/2,y,{align:'center'}); y+=8;
    var tCols=['Disciplina','Bajo','Medio','Alto','Critico'];
    var tCws=[80,27,27,27,27]; var tsx=12; var tRowH=8;
    // Encabezado tabla
    doc.setFillColor(50,50,50); doc.rect(tsx,y-5,188,tRowH,'F');
    var cx=tsx+1;
    tCols.forEach(function(c,i){
      doc.setFont(undefined,'bold'); doc.setFontSize(8.5); doc.setTextColor(255,255,255);
      doc.text(c,cx+tCws[i]/2,y,{align:'center'}); cx+=tCws[i];
    });
    doc.setTextColor(0,0,0); y+=tRowH-2;
    doc.setDrawColor(180,180,180); doc.setLineWidth(0.2); doc.line(tsx,y,200,y); y+=3;

    discKeys.forEach(function(disc,ri){
      if(ri%2===0){ doc.setFillColor(250,244,244); doc.rect(tsx,y-4,188,tRowH,'F'); }
      cx=tsx+1;
      var vals=[disc,porDI[disc+'-Bajo']||0,porDI[disc+'-Medio']||0,porDI[disc+'-Alto']||0,(porDI[disc+'-Critico']||0)+(porDI[disc+'-Cr√≠tico']||0)];
      vals.forEach(function(v,i){
        doc.setFont(undefined,i===0?'normal':'bold'); doc.setFontSize(8.5); doc.setTextColor(0,0,0);
        if(i>0){
          var num=Number(v);
          if(num>0){
            var tc=i===1?[46,125,50]:i===2?[200,140,0]:i===3?[255,140,0]:[198,40,40];
            doc.setTextColor(tc[0],tc[1],tc[2]);
          }
        }
        doc.text(String(v),cx+tCws[i]/2,y,{align:'center'}); cx+=tCws[i];
      });
      doc.setTextColor(0,0,0); y+=tRowH;
      doc.setDrawColor(220,220,220); doc.line(tsx,y-2,200,y-2);
    });
    pie(pagEst,totalPags);

    // ===== MATRIZ GENERAL =====
    doc.addPage(); enc();
    var pagMat=registros.length+3; y=16;

    doc.setFillColor(40,40,40); doc.rect(10,y,190,11,'F');
    doc.setFontSize(12); doc.setFont(undefined,'bold'); doc.setTextColor(255,255,255);
    doc.text("MATRIZ GENERAL DE OBSERVACIONES",pw/2,y+7.5,{align:'center'});
    doc.setTextColor(0,0,0); y+=15;

    // Definici√≥n columnas (total ancho=190, desde x=10 hasta x=200)
    // #  | Disc | Resp | Imp | Lugar | Observacion
    var mDefs=[
      {label:'#',        w:10},
      {label:'Disciplina', w:30},
      {label:'Responsable',w:35},
      {label:'Impacto',  w:20},
      {label:'Ubicacion',w:38},
      {label:'Descripcion',w:57}
    ]; // suma=190
    var mStartX=10;
    var limitMat=ph-mB-16;
    var mRowH=7;

    function drawTableHeader(yy){
      var cx=mStartX;
      // Fondo encabezado
      doc.setFillColor(30,30,30); doc.rect(mStartX,yy-5,190,mRowH+1,'F');
      // Texto encabezados
      mDefs.forEach(function(col){
        doc.setFont(undefined,'bold'); doc.setFontSize(7); doc.setTextColor(255,255,255);
        doc.text(col.label, cx+col.w/2, yy, {align:'center'});
        cx+=col.w;
      });
      doc.setTextColor(0,0,0);
      // L√≠nea debajo
      doc.setDrawColor(80,80,80); doc.setLineWidth(0.5);
      doc.line(mStartX,yy+2,mStartX+190,yy+2);
      // L√≠neas verticales encabezado
      var vx=mStartX;
      doc.setDrawColor(80,80,80); doc.setLineWidth(0.3);
      mDefs.forEach(function(col){ doc.line(vx,yy-5,vx,yy+3); vx+=col.w; });
      doc.line(vx,yy-5,vx,yy+3);
      return yy+5;
    }

    function drawRow(r, idx, yy){
      var fotos=r.fotos||(r.foto?[r.foto]:[]);
      var descWrap =doc.splitTextToSize(r.observacion||'-', mDefs[5].w-3);
      var lugarWrap=doc.splitTextToSize(r.lugar||'-',       mDefs[4].w-3);
      var respWrap =doc.splitTextToSize(r.responsable||'-', mDefs[2].w-3);
      var discWrap =doc.splitTextToSize(r.disciplina||'-',  mDefs[1].w-3);
      var maxL=Math.max(descWrap.length,lugarWrap.length,respWrap.length,discWrap.length,1);
      var rH=Math.max(mRowH, maxL*4.2+4);

      // Fondo alternado
      if(idx%2===0){ doc.setFillColor(252,246,246); } else { doc.setFillColor(255,255,255); }
      doc.rect(mStartX,yy,190,rH,'F');

      var cellY=yy+3.5;
      var cx=mStartX;
      var colImpFill={'Critico':[198,40,40],'Cr√≠tico':[198,40,40],'Alto':[255,140,0],'Medio':[200,140,0],'Bajo':[46,125,50]}[r.impacto]||[0,0,0];

      // # numero
      doc.setFont(undefined,'bold'); doc.setFontSize(7); doc.setTextColor(80,80,80);
      doc.text(String(idx+1), cx+mDefs[0].w/2, cellY, {align:'center'}); cx+=mDefs[0].w;

      // Disciplina
      var dc=coloresDisc[r.disciplina]||[0,0,0];
      doc.setFont(undefined,'bold'); doc.setFontSize(6.5); doc.setTextColor(dc[0],dc[1],dc[2]);
      doc.text(discWrap, cx+2, cellY); cx+=mDefs[1].w;

      // Responsable
      doc.setFont(undefined,'normal'); doc.setFontSize(6.5); doc.setTextColor(40,40,40);
      doc.text(respWrap, cx+2, cellY); cx+=mDefs[2].w;

      // Impacto (badge con fondo de color)
      doc.setFillColor(colImpFill[0],colImpFill[1],colImpFill[2]);
      doc.roundedRect(cx+1,yy+1.5,mDefs[3].w-2,5,1,1,'F');
      doc.setFont(undefined,'bold'); doc.setFontSize(6.5); doc.setTextColor(255,255,255);
      doc.text(r.impacto||'-', cx+mDefs[3].w/2, yy+5, {align:'center'}); cx+=mDefs[3].w;
      doc.setTextColor(40,40,40);

      // Ubicacion
      doc.setFont(undefined,'normal'); doc.setFontSize(6.5);
      doc.text(lugarWrap, cx+2, cellY); cx+=mDefs[4].w;

      // Descripcion
      doc.setFont(undefined,'normal'); doc.setFontSize(6.5);
      doc.text(descWrap, cx+2, cellY);

      // L√≠neas verticales de la fila
      var vx=mStartX;
      doc.setDrawColor(210,210,210); doc.setLineWidth(0.2);
      mDefs.forEach(function(col){ doc.line(vx,yy,vx,yy+rH); vx+=col.w; });
      doc.line(vx,yy,vx,yy+rH);

      // L√≠nea horizontal inferior
      doc.setDrawColor(200,200,200); doc.line(mStartX,yy+rH,mStartX+190,yy+rH);

      doc.setTextColor(0,0,0);
      return yy+rH;
    }

    y=drawTableHeader(y);

    registros.forEach(function(r,idx){
      // Estimar altura necesaria
      var descWrap =doc.splitTextToSize(r.observacion||'-', mDefs[5].w-3);
      var lugarWrap=doc.splitTextToSize(r.lugar||'-',       mDefs[4].w-3);
      var respWrap =doc.splitTextToSize(r.responsable||'-', mDefs[2].w-3);
      var discWrap =doc.splitTextToSize(r.disciplina||'-',  mDefs[1].w-3);
      var maxL=Math.max(descWrap.length,lugarWrap.length,respWrap.length,discWrap.length,1);
      var rH=Math.max(mRowH,maxL*4.2+4);

      if(y+rH>limitMat){
        pie(pagMat,totalPags); pagMat++;
        doc.addPage(); enc(); y=16;
        doc.setFillColor(40,40,40); doc.rect(10,y,190,11,'F');
        doc.setFontSize(10); doc.setFont(undefined,'bold'); doc.setTextColor(255,255,255);
        doc.text("MATRIZ GENERAL - continuacion",pw/2,y+7.5,{align:'center'});
        doc.setTextColor(0,0,0); y+=15;
        y=drawTableHeader(y);
      }
      y=drawRow(r,idx,y);
    });

    pie(pagMat,totalPags);

    doc.save('SCJ-VIS-TEC-INF-'+(siglasProyecto[nombreProyecto]||'PRY')+'.pdf');
    alert("PDF generado con "+registros.length+" observaciones");
  });

});
</script>
</body>
</html>
